<!DOCTYPE html>
<html>
<head>
    <title>Timeline</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link rel="icon" type="image/png" href="images/favicons/timeline.ico" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous" />
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <link rel="stylesheet" type="text/css" href="css/weather.css">
    <script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous" />
    <link rel="stylesheet" type="text/css" href="css/timeline.css" />
    <style type="text/css">
      ul.timeline {
          list-style-type: none;
          position: relative;
      }
      ul.timeline:before {
          content: ' ';
          background: #d4d9df;
          display: inline-block;
          position: absolute;
          left: 29px;
          width: 2px;
          height: 100%;
          z-index: 400;
      }
      ul.timeline > li {
          margin: 20px 0;
          padding-left: 20px;
      }
      ul.timeline > li:before {
          content: ' ';
          background: white;
          display: inline-block;
          position: absolute;
          border-radius: 50%;
          border: 3px solid #22c0e8;
          left: 20px;
          width: 20px;
          height: 20px;
          z-index: 400;
      }
    </style>
</head>
<body>
    <nav class="navbar navbar-light fixed-top" style="background-color: #025f80;">
        <a href="#" class="navbar-brand d-flex flex-row justify-content-start" style="font-family: GrenzeGotisch; padding: 0; font-size: 27px; color: #c3d6e7;">
            <img src="images/timeline.png" width="40" height="40" class="d-inline-block align-top" alt="" loading="lazy" style="margin-right: 10px;" />
            ShowTime
        </a>
        <!--Weather API -->
        <div class="d-flex flex-row justify-content-start weather navbar-nav mr-auto">
          <p class="text-light text-center"><i class="fas fa-cloud-sun"></i><span id="hohoho"></span></p>
          <p class="text-light text-center"><i class="fas fa-temperature-low"></i><span id="hehehe"></span></p>
          <p class="text-light text-center"><i class="far fa-compass"></i><span id="reroro"></span></p>
        </div>
        <div class="dropdown">
            <img src="images/account.png" width="40" height="40" class="dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" />
            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu2">
                <a href="account_page.html" class="dropdown-item" type="button">
                    <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-person-square" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M14 1H2a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z" />
                        <path fill-rule="evenodd" d="M2 15v-1c0-1 1-4 6-4s6 3 6 4v1H2zm6-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />
                    </svg>
                    My Account
                </a>
                <a href="budget.html" class="dropdown-item" type="button">
                    <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-pie-chart-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15.985 8.5H8.207l-5.5 5.5a8 8 0 0 0 13.277-5.5zM2 13.292A8 8 0 0 1 7.5.015v7.778l-5.5 5.5zM8.5.015V7.5h7.485A8.001 8.001 0 0 0 8.5.015z" />
                    </svg>
                    Budget Tracker
                </a>
                <a href="#" class="dropdown-item" type="button">
                    <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-box-arrow-left" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path
                            fill-rule="evenodd"
                            d="M6 12.5a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v2a.5.5 0 0 1-1 0v-2A1.5 1.5 0 0 1 6.5 2h8A1.5 1.5 0 0 1 16 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-8A1.5 1.5 0 0 1 5 12.5v-2a.5.5 0 0 1 1 0v2z"
                        />
                        <path fill-rule="evenodd" d="M.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L1.707 7.5H10.5a.5.5 0 0 1 0 1H1.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z" />
                    </svg>
                    Log Out
                </a>
            </div>
        </div>
    </nav>
    <div style="height: 55px;"></div>
    <!--floating hoverable side navigation bar-->
    <div id="mySidenav" class="sidenav">
        <a href="create_diary.html" id="first">+Diary</a>
        <a href="create_event.html" id="second">+Event</a>
        <a href="create_reminder.html" id="third">+Reminder</a>
        <a href="create_transaction.html" id="fourth">+Transaction</a>
    </div>

    <div class="bottom-menu">
        <div style="height: 55px;"></div>
        <div class="nav-icons d-flex flex-row justify-content-center fixed-bottom text-center">
            <div class="icon active-button">
                <i class="fas fa-sort-amount-down"></i>
            </div>
            <a href="create_diary.html" class="icon">
                <i class="fas fa-feather-alt"></i>
            </a>
            <a href="create_event.html" class="icon">
                <i class="far fa-calendar-plus"></i>
            </a>
            <a href="create_reminder.html" class="icon">
                <i class="fas fa-tasks"></i>
            </a>
            <a href="create_transaction.html" class="icon">
                <i class="fas fa-hand-holding-usd"></i>
            </a>
        </div>
    </div>
    <div class="container mt-5 mb-5">
      <div class="row">
        <div class="col-md-10 offset-md-1">
        <form>
			<div class="form-group">
				<label for="date">Start From</label>
				<input type="datetime-local" class="form-control" id="start" name="start">
				<small class="error">Invalid Date!</small>
			</div>
			<div class="form-group">
				<label for="date">Until</label>
				<input type="datetime-local" class="form-control" id="end" name="end">
				<small class="error">Invalid Date!</small>
			</div>
			<button type="submit" class="btn btn-info btn-lg btn-block" id="submitBtn">Search</button>
		</form>
		 <h4><br> </h4>
          <h4> My Timeline </h4>
          <ul class="timeline" id="myTimeline">
          </ul>
          <h4> Public Timeline </h4>
          <ul class="timeline" id="publicTimeline">
          </ul>
        </div>
      </div>
    </div>

    <footer>
        <div class="text-center">
            <a href="https://github.com/CSCI201-ShowTime" target="_blank"><i class="fab fa-github"></i> ShowTime</a>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
    <script src="js/weather.js"></script>
    <script>
    let today = new Date();
    let ye = new Intl.DateTimeFormat('en', { year: 'numeric' }).format(today);
    let mo = new Intl.DateTimeFormat('en', { month: '2-digit' }).format(today);
    let da = new Intl.DateTimeFormat('en', { day: '2-digit' }).format(today);
    let start = `${ye}-${mo}-${da}T00:00`;
    let end = `${ye}-${mo}-${da}T23:59`;
    document.querySelector("#start").value = start;
    document.querySelector("#end").value = end;
    refreshPage(start, end);
	document.querySelector("form").onsubmit = function(e){
	
		e.preventDefault();
		let start = document.querySelector("#start").value;
		let end = document.querySelector("#end").value;
		let startObj = new Date(start);
		let endObj = new Date(end);
		if ( isNaN(startObj.getTime()) || isNaN(endObj.getTime()) || (startObj.getTime() > endObj.getTime()) ) {
			document.querySelector("#start + .error").style.display = "block";
			document.querySelector("#end + .error").style.display = "block";
		} else {
			document.querySelector("#start + .error").style.display = "none";
			document.querySelector("#end + .error").style.display = "none";
			refreshPage(start, end);
		}
	}
    function formatDate(dateStr) {
         let remindTimeFormat = new Date(dateStr);
         let ye = new Intl.DateTimeFormat('en', { year: 'numeric' }).format(remindTimeFormat);
         let mo = new Intl.DateTimeFormat('en', { month: 'long' }).format(remindTimeFormat);
         let da = new Intl.DateTimeFormat('en', { day: '2-digit' }).format(remindTimeFormat);
         let hr = ("0" + remindTimeFormat.getHours()).slice(-2);
         let mi = ("0" + remindTimeFormat.getMinutes()).slice(-2);
         let remindTimeFormatString = `${mo} ${da}, ${ye} ` + hr + ":" + mi;
         return remindTimeFormatString;
    }


  function refreshPage(searchStartTime, searchEndTime){
	  
	    var responseUserID = 123;
		function getUserId(){
			var result = 1;
			
			$.ajax({
				url : '/api/userid',
				type : "GET",
				async : false,
				success : function(data) {
					result = data;
				}
			});
			
			return result;
		}
		
		$.when(getUserId()).done(function(result){
			var responseUserID =  result;
			
		}).fail(function(){
			alert("$.get failed");
		});
		
		var userId = getUserId();
      	let timeline = document.querySelector("#myTimeline");
      	let publicTimeline = document.querySelector("#publicTimeline");
  		var myUrl = '/api/event/personalEvent' + '?userid=' + userId + '&start=' + searchStartTime + "&start=" + searchEndTime;
    var parsedJson;
  
    $.ajax({
    url: myUrl,
    type: 'GET',
    contentType: 'application/json; charset=utf-8',
    success: function (data, textStatus, xhr) {
      myJSON = JSON.stringify(data);
      parsedJson = JSON.parse(myJSON); 
            
      while( timeline.hasChildNodes()) {
        timeline.removeChild(timeline.lastChild);
      }

      for (var i = 0; i < parsedJson.length; i++) {
        let li = document.createElement("li");
        let a1 = document.createElement("a");
        let a2 = document.createElement("a");
        let text = document.createElement("p");
        let property = document.createElement("p");
        if (parsedJson[i].type == "reminder") {
          a1.innerHTML = "Reminder: " + parsedJson[i].title;
          if (parsedJson[i].priority < 5){
            property.innerHTML = "Priority: Low";
          } else if (parsedJson[i].priority > 5){
            property.innerHTML = "Priority: High";
          } else {
            property.innerHTML = "Priority: Medium";
          }
          property.innerHTML += " Remind Time: " + formatDate(parsedJson[i].remind_time);
        } else if (parsedJson[i].type == "durationevent") {
          a1.innerHTML = "Event: " + parsedJson[i].title;
          property.innerHTML = "Remind Time: " + formatDate(parsedJson[i].remind_time);
        } else if (parsedJson[i].type == "diary") {
          a1.innerHTML = "Diary: " + parsedJson[i].title;
        } else if (parsedJson[i].type == "budget") {
          a1.innerHTML = "Budget: " + parsedJson[i].title;
          property.innerHTML = "Amount: $" + parsedJson[i].amount;
          property.innerHTML += " Category: " + parsedJson[i].category;
        } else {
          a1.innerHTML = "" + parsedJson[i].title;
        }
        
        a1.href = "#";
        a2.innerHTML = formatDate(parsedJson[i].start);
        a2.href = "#";
        a2.classList.add('float-right');
        text.innerHTML = parsedJson[i].description;
        li.appendChild(a1);
        li.appendChild(a2);
        li.appendChild(text);
        li.appendChild(property);
        timeline.appendChild(li);
      }
    },
    error: function (data, textStatus, xhr) {
      alert(data.responseText);
    }
  })
  
  var publicUrl = '/api/event/publicEvent' + '?userid=' + userId + '&start=' + searchStartTime + "&start=" + searchEndTime;
	  
  $.ajax({
	    url: publicUrl,
	    type: 'GET',
	    contentType: 'application/json; charset=utf-8',
	    success: function (data, textStatus, xhr) {
	      myJSON = JSON.stringify(data);
	      parsedJson = JSON.parse(myJSON); 
	            
	      while( publicTimeline.hasChildNodes()) {
	    	  publicTimeline.removeChild(publicTimeline.lastChild);
	      }

	      for (var i = 0; i < parsedJson.length; i++) {
	        let li = document.createElement("li");
	        let a1 = document.createElement("a");
	        let a2 = document.createElement("a");
	        let text = document.createElement("p");
	        let property = document.createElement("p");
	        a1.innerHTML = "Public Event: " + parsedJson[i].title;
	         property.innerHTML = "Remind Time: " + formatDate(parsedJson[i].remind_time);
	        a1.href = "#";
	        a2.innerHTML = formatDate(parsedJson[i].start);
	        a2.href = "#";
	        a2.classList.add('float-right');
	        text.innerHTML = parsedJson[i].description;
	        li.appendChild(a1);
	        li.appendChild(a2);
	        li.appendChild(text);
	        li.appendChild(property);
	        publicTimeline.appendChild(li);
	      }
	    },
	    error: function (data, textStatus, xhr) {
	      alert(data.responseText);
	    }
	  })
	  }    
    </script>
    
	<!-- Bilibiliy (v0.2.6): Server-side Communication Script -->
    <script type="text/javascript" src="js/server/logout-server.js"></script>
    <!-- Bilibiliy (v0.2.6): This should be integrated into account_page.js -->
    <script type="text/javascript" src="js/server/logout-navbar-temp.js"></script>
</body>
</html>
